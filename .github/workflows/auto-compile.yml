name: Auto-compile protocols.json

on:
  push:
    branches: [ main ]
    paths:
      - 'protocols/**'
      - 'scripts/compile.js'

permissions:
  contents: write
  issues: write

jobs:
  compile:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Compile protocols
      run: |
        echo "ğŸ”¨ Compiling individual protocol files..."
        node scripts/compile.js

    - name: Check for changes
      id: changes
      run: |
        if git diff --quiet protocols.json; then
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "No changes to protocols.json"
        else
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "protocols.json has been updated"
        fi

    - name: Commit updated protocols.json
      if: steps.changes.outputs.changed == 'true'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add protocols.json
        git commit -m "chore: auto-compile protocols.json from individual files"
        git push

    - name: Get protocols info
      if: steps.changes.outputs.changed == 'true'
      id: info
      run: |
        PROTOCOLS_COUNT=$(jq '.protocols | length' protocols.json)
        LAST_UPDATED=$(jq -r '.lastUpdated' protocols.json)
        echo "count=$PROTOCOLS_COUNT" >> $GITHUB_OUTPUT
        echo "updated=$LAST_UPDATED" >> $GITHUB_OUTPUT
        echo "âœ… Compiled $PROTOCOLS_COUNT protocols"
        echo "ğŸ“… Last updated: $LAST_UPDATED"

    - name: Create sync issue in frontend repo
      if: steps.changes.outputs.changed == 'true' && secrets.FRONTEND_PAT != ''
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.FRONTEND_PAT }}
        script: |
          const owner = context.repo.owner;
          const currentRepo = context.repo.repo;
          const frontendRepo = 'operators-frontend';

          const issueBody = `## ğŸ”„ Operators Data Updated

          The operators repository has been updated with new or modified protocols.

          **Changes:**
          - **Protocols count:** ${{ steps.info.outputs.count }}
          - **Last updated:** ${{ steps.info.outputs.updated }}
          - **Commit:** [\`${{ github.sha }}\`](https://github.com/${owner}/${currentRepo}/commit/${{ github.sha }})

          **Action needed:**
          Update the git submodule to pull the latest changes:

          \`\`\`bash
          cd data/operators
          git pull origin main
          cd ../..
          git add data/operators
          git commit -m "chore: update operators data submodule"
          git push
          \`\`\`

          **Or use npm script:**
          \`\`\`bash
          npm run sync-logos  # Also syncs logos from GitHub
          \`\`\`

          ---
          *This issue was automatically created by the operators repo when protocols.json was updated.*
          `;

          try {
            // Check if there's already an open issue
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: owner,
              repo: frontendRepo,
              state: 'open',
              labels: 'sync,automated'
            });

            const existingIssue = issues.find(issue =>
              issue.title.includes('Operators Data Updated') ||
              issue.title.includes('Sync needed')
            );

            if (existingIssue) {
              // Update existing issue with comment
              await github.rest.issues.createComment({
                owner: owner,
                repo: frontendRepo,
                issue_number: existingIssue.number,
                body: `ğŸ”„ New update available!\n\n${issueBody}`
              });
              console.log(`âœ… Updated existing issue #${existingIssue.number}`);
            } else {
              // Create new issue
              const { data: issue } = await github.rest.issues.create({
                owner: owner,
                repo: frontendRepo,
                title: 'ğŸ”„ Operators Data Updated - Sync Required',
                body: issueBody,
                labels: ['sync', 'automated']
              });
              console.log(`âœ… Created new sync issue #${issue.number} in operators-frontend`);
            }
          } catch (error) {
            console.error('Failed to create/update issue:', error.message);
            core.setFailed(`Failed to create sync issue: ${error.message}`);
          }

    - name: Notify sync needed (fallback)
      if: steps.changes.outputs.changed == 'true' && secrets.FRONTEND_PAT == ''
      run: |
        echo "::warning::ğŸ“¢ protocols.json was updated but FRONTEND_PAT secret is not configured"
        echo "::warning::To enable automatic issue creation in operators-frontend, add a FRONTEND_PAT secret with repo access"
        echo ""
        echo "â„¹ï¸  Sync instructions:"
        echo "   cd operators-frontend/data/operators"
        echo "   git pull origin main"