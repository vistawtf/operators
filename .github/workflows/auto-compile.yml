name: Auto-compile protocols.json

on:
  push:
    branches: [ main ]
    paths:
      - 'protocols/**'
      - 'scripts/compile.js'

permissions:
  contents: write
  issues: write

jobs:
  compile:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Compile protocols
      run: |
        echo "üî® Compiling individual protocol files..."
        node scripts/compile.js

    - name: Check for changes
      id: changes
      run: |
        if git diff --quiet protocols.json; then
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "No changes to protocols.json"
        else
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "protocols.json has been updated"
        fi

    - name: Commit updated protocols.json
      if: steps.changes.outputs.changed == 'true'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add protocols.json
        git commit -m "chore: auto-compile protocols.json from individual files"
        git push

    - name: Get protocols info
      if: steps.changes.outputs.changed == 'true'
      id: info
      run: |
        PROTOCOLS_COUNT=$(jq '.protocols | length' protocols.json)
        LAST_UPDATED=$(jq -r '.lastUpdated' protocols.json)
        echo "count=$PROTOCOLS_COUNT" >> $GITHUB_OUTPUT
        echo "updated=$LAST_UPDATED" >> $GITHUB_OUTPUT
        echo "‚úÖ Compiled $PROTOCOLS_COUNT protocols"
        echo "üìÖ Last updated: $LAST_UPDATED"

    - name: Trigger frontend sync workflow
      if: steps.changes.outputs.changed == 'true' && secrets.FRONTEND_PAT != ''
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.FRONTEND_PAT }}
        script: |
          const owner = context.repo.owner;
          const frontendRepo = 'operators-frontend';

          try {
            await github.rest.repos.createDispatchEvent({
              owner: owner,
              repo: frontendRepo,
              event_type: 'operators-data-updated',
              client_payload: {
                protocols_count: ${{ steps.info.outputs.count }},
                last_updated: '${{ steps.info.outputs.updated }}',
                commit_sha: '${{ github.sha }}',
                commit_url: 'https://github.com/${{ github.repository }}/commit/${{ github.sha }}'
              }
            });
            console.log('‚úÖ Triggered sync workflow in operators-frontend');
          } catch (error) {
            console.error('‚ö†Ô∏è  Failed to trigger frontend workflow:', error.message);
            console.log('Frontend will need manual sync');
          }

    - name: Sync complete notification
      if: steps.changes.outputs.changed == 'true'
      run: |
        echo "‚úÖ protocols.json compiled and pushed"
        echo "üìä Protocols: ${{ steps.info.outputs.count }}"
        echo "üïí Updated: ${{ steps.info.outputs.updated }}"
        echo ""
        if [ -z "${{ secrets.FRONTEND_PAT }}" ]; then
          echo "‚ÑπÔ∏è  To enable automatic frontend sync, add FRONTEND_PAT secret"
          echo "   See .github/SETUP.md for instructions"
        else
          echo "üîî Frontend sync workflow triggered automatically"
        fi